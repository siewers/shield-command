<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ShieldCommander.UI.ViewModels"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             xmlns:models="using:ShieldCommander.Core.Models"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="ShieldCommander.UI.Views.DeviceView"
             x:DataType="vm:DeviceViewModel">

    <ScrollViewer>
    <StackPanel Spacing="16">

        <!-- Connect form (shown when disconnected) -->
        <StackPanel Spacing="8" IsVisible="{Binding !IsConnected}">
            <TextBlock Text="Shield IP Address"/>
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="4">
                <Grid Grid.Column="0">
                    <AutoCompleteBox x:Name="IpAutoComplete"
                                     Text="{Binding IpAddress, Mode=TwoWay}"
                                     ItemsSource="{Binding DeviceSuggestions}"
                                     Watermark="192.168.1.x â€” type or select a device"
                                     FilterMode="Contains"
                                     MinimumPrefixLength="0"
                                     MinimumPopulateDelay="0"
                                     MaxDropDownHeight="300">
                        <AutoCompleteBox.Styles>
                            <Style Selector="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            </Style>
                            <Style Selector="TextBox">
                                <Setter Property="MinHeight" Value="0"/>
                                <Setter Property="Padding" Value="8,4"/>
                            </Style>
                        </AutoCompleteBox.Styles>
                        <AutoCompleteBox.ItemTemplate>
                            <DataTemplate x:DataType="models:DeviceSuggestion">
                                <Grid ColumnDefinitions="140,*,Auto">
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding IpAddress}"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               Foreground="Gray"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding Source, StringFormat=({0})}"
                                               Foreground="DimGray"
                                               FontSize="11"
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </AutoCompleteBox.ItemTemplate>
                    </AutoCompleteBox>
                    <Button x:Name="DropdownButton"
                            Content="&#xE70D;"
                            FontFamily="{StaticResource SymbolThemeFontFamily}"
                            FontSize="12"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Stretch"
                            Padding="8,0"
                            Background="Transparent"
                            BorderThickness="0"
                            Click="DropdownButton_Click"/>
                </Grid>
                <Button Grid.Column="1"
                        Content="Connect"
                        Command="{Binding ConnectCommand}"
                        IsEnabled="{Binding !IsBusy}"
                        Classes="accent"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <ui:ProgressRing Width="16" Height="16"
                                     IsIndeterminate="True"
                                     IsVisible="{Binding IsScanning}"/>
                    <Button Content="Rescan"
                            Command="{Binding RescanCommand}"
                            IsEnabled="{Binding !IsScanning}"
                            ToolTip.Tip="Scan network for Shield devices"/>
                </StackPanel>
            </Grid>
        </StackPanel>

        <!-- Connected banner (shown when connected) -->
        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                CornerRadius="4" Padding="12"
                IsVisible="{Binding IsConnected}">
            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                <TextBlock Grid.Column="0"
                           Text="Connected to:"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1"
                           Text="{Binding IpAddress}"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"/>
                <TextBlock Grid.Column="2"
                           Text="{Binding ConnectedDeviceName}"
                           Foreground="Gray"
                           Margin="12,0,0,0"
                           VerticalAlignment="Center"/>
                <Button Grid.Column="3"
                        Content="Disconnect"
                        Command="{Binding DisconnectCommand}"
                        IsEnabled="{Binding !IsBusy}"
                        VerticalAlignment="Center"
                        Padding="8,4"/>
            </Grid>
        </Border>

        <!-- Saved devices (only when disconnected) -->
        <TextBlock Text="Saved Devices" FontSize="16" FontWeight="SemiBold"
                   Margin="0,8,0,0"
                   IsVisible="{Binding !IsConnected}"/>

        <ItemsControl ItemsSource="{Binding SavedDevices}"
                      IsVisible="{Binding !IsConnected}">
            <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:SavedDevice">
                    <Border Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                            CornerRadius="4" Padding="12,8" Margin="0,2">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{Binding IpAddress}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding DeviceName}"
                                       Foreground="Gray"
                                       Margin="12,0,0,0"
                                       VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4"
                                        VerticalAlignment="Center">
                                <ToggleButton IsChecked="{Binding AutoConnect, Mode=OneWay}"
                                              Command="{Binding $parent[ItemsControl].((vm:DeviceViewModel)DataContext).ToggleAutoConnectCommand}"
                                              CommandParameter="{Binding}"
                                              ToolTip.Tip="Auto-connect on startup"
                                              Padding="6,4"
                                              FontFamily="{StaticResource SymbolThemeFontFamily}"
                                              FontSize="14"
                                              Content="&#xE734;"/>
                                <Button Content="Connect"
                                        Command="{Binding $parent[ItemsControl].((vm:DeviceViewModel)DataContext).ConnectToSavedCommand}"
                                        CommandParameter="{Binding}"
                                        Padding="8,4" />
                                <Button Content="Remove"
                                        Command="{Binding $parent[ItemsControl].((vm:DeviceViewModel)DataContext).RemoveSavedDeviceCommand}"
                                        CommandParameter="{Binding}"
                                        Padding="8,4" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </StackPanel>
    </ScrollViewer>
</UserControl>
